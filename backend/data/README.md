## Data model overview

WAL mode is enabled for concurrent reads/writes.

### Tables

#### users
- id: INTEGER, primary key
- username: TEXT, unique, not null
- password_hash: TEXT, nullable (dev mode can have no password)
- created_at: DATETIME, default now

Relationships:
- users.id → interactions.user_id (FK)
- users.id → served_posts.user_id (FK)

#### posts
- id: INTEGER, primary key
- post_id: TEXT, unique nullable external/source identifier (e.g., CSV id)
- title: TEXT, not null
- self_text: TEXT, not null
- subreddit: TEXT, nullable
- over_18: BOOLEAN, not null, default false
- link_flair_text: TEXT, nullable
- is_ai: BOOLEAN, not null, default false (real posts are false; AI queue items are ephemeral until interacted with)
- random_key: INTEGER, not null, indexed (used for random-window sampling)

Relationships:
- posts.id → interactions.post_id (FK)
- posts.id → served_posts.post_id (FK)

Notes:
- Treat `posts.id` (INTEGER) as the canonical internal identifier for all interactions. `posts.post_id` is the optional external/source id.

#### interactions
- id: INTEGER, primary key
- user_id: INTEGER, not null, FK → users.id (ON DELETE CASCADE)
- post_id: INTEGER, not null, FK → posts.id (ON DELETE CASCADE)
- action: TEXT, not null. One of: `like`, `dislike`, `next` (skipped), `markedai` (user marked as AI)
- created_at: DATETIME, default now

Constraints/Indexes:
- UNIQUE (user_id, post_id, action) as `uq_user_post_action` (prevents duplicate interactions of the same type for the same user and post)

#### served_posts
- id: INTEGER, primary key
- user_id: INTEGER, not null, FK → users.id (ON DELETE CASCADE)
- post_id: INTEGER, not null, FK → posts.id (ON DELETE CASCADE)
- served_at: DATETIME, default now

Constraints/Indexes:
- UNIQUE (user_id, post_id) as `uq_user_post_served` (prevents re-serving within a session)

Notes:
- Cleared at server startup so that no-repeat applies only during a single server run. Between restarts, posts can be reshown.

#### ai_generated_posts
- id: INTEGER, primary key
- title: TEXT, not null
- self_text: TEXT, not null
- subreddit: TEXT, nullable
- model_name: TEXT, nullable (producer/variant)
- prompt: TEXT, nullable (optional provenance)
- generated_at: DATETIME, default now

Purpose:
- Archive of AI posts generated by the background worker. These are not sampled by `/feed` directly; the feed pulls AI items from an in-memory queue. With `--archive`, the queue is filled from this table instead of generating new items.

## Key behaviors

### Feed sampling and serving
- `/feed` samples random real posts from `posts` excluding those already present in `served_posts` for the user, then records the served rows into `served_posts`.
- Number of AI posts interleaved is controlled by `AI_POSTS_RATIO` in `config.py`.
- `served_posts` is cleared at server startup.

### Interactions
- `like`/`dislike`: recorded in `interactions` with unique constraint; no implicit `next` is added.
- `next` (skipped): recorded for all posts that were shown but not otherwise interacted with when the user requests the next page. A batch endpoint records these in one call.
- `markedai`: recorded when the user marks a post as AI.

## Identifiers: internal vs external
- Internal id: `posts.id` (INTEGER) — use this for FK references and writing interactions.
- External id: `posts.post_id` (TEXT) — optional source identifier; do not rely on it for joins if the internal `id` is available.
